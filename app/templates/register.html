{% extends 'base.html' %}
{% block content %}
<section class="section">
  <div class="container">
    <h2 class="title">Register</h2>

    <form method="post" novalidate id="registerForm">
      {{ form.hidden_tag() }}

      <!-- Username -->
      <div class="field">
        <label class="label" for="username">Username</label>
        <div class="control">
          {{ form.username(
               class="input",
               id="username",
               placeholder="Choose a username",
               required=True,
               minlength=4,
               maxlength=16
          ) }}
        </div>
        <p class="help is-danger" id="usernameHelp" style="display:none;">
          Must be 4–16 characters.
        </p>
        {% for err in form.username.errors %}
          <p class="help is-danger">{{ err }}</p>
        {% endfor %}
      </div>

      <!-- Email -->
      <div class="field">
        <label class="label" for="email">Email</label>
        <div class="control">
          {{ form.email(
               class="input",
               id="email",
               placeholder="you@example.com",
               required=True
          ) }}
        </div>
        <p class="help is-danger" id="emailHelp" style="display:none;">
          Enter a valid email address.
        </p>
        {% for err in form.email.errors %}
          <p class="help is-danger">{{ err }}</p>
        {% endfor %}
      </div>

      <!-- Password -->
      <div class="field">
        <label class="label" for="password">Password</label>
        <div class="control">
          {{ form.password(
               class="input",
               id="password",
               type="password",
               placeholder="••••••••",
               required=True,
               minlength=8,
               maxlength=16
          ) }}
        </div>
        <p class="help is-danger" id="passwordHelp" style="display:none;">
          8–16 chars, 1 uppercase, 1 lowercase, 1 digit & 1 special.
        </p>
        {% for err in form.password.errors %}
          <p class="help is-danger">{{ err }}</p>
        {% endfor %}
      </div>

      <!-- Confirm Password -->
      <div class="field">
        <label class="label" for="confirm_password">Confirm Password</label>
        <div class="control">
          <input
            class="input"
            id="confirm_password"
            name="{{ form.confirm_password.name }}"
            type="password"
            placeholder="Repeat password"
            required
            minlength="8"
            maxlength="16"
          >
        </div>
        <p class="help is-danger" id="confirmHelp" style="display:none;">
          Passwords must match.
        </p>
        {% for err in form.confirm_password.errors %}
          <p class="help is-danger">{{ err }}</p>
        {% endfor %}
      </div>

      <div class="field">
        <div class="control">
          <button type="submit" class="button is-primary">{{ form.submit.label.text }}</button>
        </div>
      </div>
    </form>
  </div>
</section>

<script>
// Utility regexes
const reEmail = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
const rePassword = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,16}$/;

// On-DOM ready
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('registerForm');
  const username = document.getElementById('username');
  const email    = document.getElementById('email');
  const password = document.getElementById('password');
  const confirm  = document.getElementById('confirm_password');

  const usernameHelp = document.getElementById('usernameHelp');
  const emailHelp    = document.getElementById('emailHelp');
  const pwHelp       = document.getElementById('passwordHelp');
  const confirmHelp  = document.getElementById('confirmHelp');

  // Validation functions
  function validateUsername() {
    const ok = username.value.length >= 4 && username.value.length <= 16;
    username.classList.toggle('is-success', ok);
    username.classList.toggle('is-danger', !ok);
    usernameHelp.style.display = ok ? 'none' : 'block';
    return ok;
  }

  function validateEmail() {
    const ok = reEmail.test(email.value);
    email.classList.toggle('is-success', ok);
    email.classList.toggle('is-danger', !ok);
    emailHelp.style.display = ok ? 'none' : 'block';
    return ok;
  }

  function validatePassword() {
    const ok = rePassword.test(password.value);
    password.classList.toggle('is-success', ok);
    password.classList.toggle('is-danger', !ok);
    pwHelp.style.display = ok ? 'none' : 'block';
    return ok;
  }

  function validateConfirm() {
    const ok = password.value === confirm.value && confirm.value.length > 0;
    confirm.classList.toggle('is-success', ok);
    confirm.classList.toggle('is-danger', !ok);
    confirmHelp.style.display = ok ? 'none' : 'block';
    return ok;
  }

  // Attach listeners
  username.addEventListener('input', validateUsername);
  email.addEventListener('input', validateEmail);
  password.addEventListener('input', () => {
    validatePassword();
    validateConfirm(); // re-check confirm if password changed
  });
  confirm.addEventListener('input', validateConfirm);

  // Final check on submit
  form.addEventListener('submit', e => {
    if (!(validateUsername() && validateEmail() && validatePassword() && validateConfirm())) {
      e.preventDefault();
    }
  });
});
</script>
{% endblock %}
